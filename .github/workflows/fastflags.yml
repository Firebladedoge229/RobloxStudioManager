name: Check Roblox FastFlags

on:
  push:
    paths:
      - "data/fastflags.json"
  pull_request:
    paths:
      - "data/fastflags.json"

permissions:
  contents: read

jobs:
  check-fastflags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check FastFlags
        run: |
          python3 << 'EOF'
          import requests, sys, re

          fastflags_url = "https://raw.githubusercontent.com/Firebladedoge229/RobloxStudioManager/refs/heads/main/data/fastflags.json"
          fvariables_url = "https://raw.githubusercontent.com/MaximumADHD/Roblox-Client-Tracker/refs/heads/roblox/FVariables.txt"
          client_settings_url = "https://clientsettingscdn.roblox.com/v2/settings/application/PCStudioApp"

          ff = requests.get(fastflags_url).json()
          fv = set(line.strip().split()[-1] for line in requests.get(fvariables_url).text.splitlines() if line.strip())
          cs = set(requests.get(client_settings_url).json().get("applicationSettings", {}).keys())
          all_src = fv | cs

          def collect(d, path=""):
              out = []
              for k, v in d.items():
                  new = f"{path} > {k}" if path else k
                  if isinstance(v, dict):
                      out.extend(collect(v, new))
                  else:
                      out.append((k, path))
              return out

          flags = list(set(collect(ff)))
          missing = []

          def norm(f):
              return {re.sub(r"\\d+$", "", f), re.sub(r"\\d+", "", f)}

          def match(f):
              n = norm(f)
              m = []
              for s in all_src:
                  if s != f and (s in n or f in norm(s)):
                      m.append(s)
              return m

          for flag, path in flags:
              if flag in all_src:
                  print(f"‚úÖ {flag} found in exact match [{path}]")
                  continue
              m = match(flag)
              if m:
                  print(f"üü° Lenient Match for {flag} [{path}] ‚Üí {m}")
                  continue
              print(f"‚ö†Ô∏è {flag} not found in either source [{path}]")
              missing.append((flag, path))

          if missing:
              print(f"\n‚ùå Missing flags: {len(missing)}")
              for f, p in missing:
                  print(f"  - {f} [{p}]")
              sys.exit(1)
          else:
              print("\nAll flags verified successfully (with leniency) ‚úÖ")
          EOF
